import streamlit as st
import pandas as pd
import folium
from streamlit_folium import st_folium
from geopy.distance import geodesic
from streamlit_javascript import st_javascript

# ì„¼í„° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì˜ˆ: DataFrameë¡œ ì§ì ‘ ë¡œë”©)
columns = ["ì„¼í„°ëª…", "ì‹œë„ëª…", "ì‹œêµ°êµ¬ëª…", "ì£¼ì†Œ", "ìœ„ë„", "ê²½ë„"]
data = [
    ["ì„œìš¸ì‹œì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ì¤‘êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ ì„ì§€ë¡œ 11ê¸¸ 23 7ì¸µ", 37.566375, 126.990471],
    ["ì¢…ë¡œêµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ì¢…ë¡œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬ ëª…ë¥œê¸¸ 90", 37.585501, 126.997992],
    ["ìš©ì‚°êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ìš©ì‚°êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ìš©ì‚°êµ¬ ë°±ë²”ë¡œ 329", 37.534241, 126.963403],
    ["ì„±ë™êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ì„±ë™êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë™êµ¬ í–‰ë‹¹ë¡œ6ê¸¸ 24-15", 37.561491, 127.026402],
    ["ê´‘ì§„êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ê´‘ì§„êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê´‘ì§„êµ¬ ì•„ì°¨ì‚°ë¡œ 24ê¸¸ 17", 37.534201, 127.067332],
    ["ë™ëŒ€ë¬¸êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë™ëŒ€ë¬¸êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë™ëŒ€ë¬¸êµ¬ ì²œí˜¸ëŒ€ë¡œ2ê¸¸ 23-9", 37.575294, 127.023249],
    ["ì¤‘ë‘êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ì¤‘ë‘êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘ë‘êµ¬ ìš©ë§ˆì‚°ë¡œ 217", 37.579624, 127.094595],
    ["ì„±ë¶êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ì„±ë¶êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë¶êµ¬ ì •ë¦‰ë¡œ 242", 37.600609, 127.009388],
    ["ì„±ë¶êµ¬ì„ê´€ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ì„±ë¶êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë¶êµ¬ ëŒê³¶ì´ë¡œ 18ê¸¸ 3-9", 37.610196, 127.064567],
    ["ê°•ë¶êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ê°•ë¶êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë¶êµ¬ 4.19ë¡œ 74", 37.644161, 127.013580],
    ["ë„ë´‰êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë„ë´‰êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë„ë´‰êµ¬ ë…¸í•´ë¡œ 69ê¸¸ 132", 37.649313, 127.050419],
    ["ë…¸ì›êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë…¸ì›êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë…¸ì›êµ¬ ìˆ˜ë½ì‚°ë¡œ212-19", 37.669865, 127.062013],
    ["ì€í‰êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ì€í‰êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì€í‰êµ¬ ë°±ë ¨ì‚°ë¡œ 4ê¸¸ 16", 37.595995, 126.924844],
    ["ì„œëŒ€ë¬¸êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ì„œëŒ€ë¬¸êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì„œëŒ€ë¬¸êµ¬ ì¦ê°€ë¡œ30ê¸¸ 45-9", 37.575033, 126.923838],
    ["ë§ˆí¬êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë§ˆí¬êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬ í¬ìš°ì •ë¡œ 77", 37.550186, 126.914264],
    ["ì–‘ì²œêµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ì–‘ì²œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì–‘ì²œêµ¬ ë‚¨ë¶€ìˆœí™˜ë¡œ83ê¸¸ 53", 37.525624, 126.839847],
    ["ê°•ì„œêµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ê°•ì„œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ì„œêµ¬ í™”ê³¡ë¡œ 18ê¸¸ 14-5", 37.539655, 126.852447],
    ["êµ¬ë¡œêµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "êµ¬ë¡œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ êµ¬ë¡œêµ¬ ì˜¤ë¦¬ë¡œ 1115", 37.487042, 126.814343],
    ["ê¸ˆì²œêµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ê¸ˆì²œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê¸ˆì²œêµ¬ ë…ì‚°ë¡œ32ë‹¤ê¸¸ 17", 37.457813, 126.901616],
    ["ì˜ë“±í¬êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ì˜ë“±í¬êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì˜ë“±í¬êµ¬ ë„ì˜ë¡œ22ê¸¸ 36", 37.524957, 126.902279],
    ["ë™ì‘êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë™ì‘êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë™ì‘êµ¬ ì—¬ì˜ëŒ€ë°©ë¡œ 20ê¸¸ 61", 37.492067, 126.927237],
    ["ê´€ì•…êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ê´€ì•…êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê´€ì•…êµ¬ ë‚¨ë¶€ìˆœí™˜ë¡œ 234ê¸¸ 73", 37.484294, 126.931754],
    ["ì„œì´ˆêµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ì„œì´ˆêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ë°©ë°°ë¡œ5ê¸¸ 11", 37.486241, 126.989012],
    ["ê°•ë‚¨êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ê°•ë‚¨êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ê´‘í‰ë¡œ 144", 37.487532, 127.1017],
    ["ì†¡íŒŒêµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ì†¡íŒŒêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ì¤‘ëŒ€ë¡œ 4ê¸¸ 4", 37.502934, 127.108922],
    ["ê°•ë™êµ¬ì²­ì†Œë…„ìƒë‹´ë³µì§€ì„¼í„°", "ì„œìš¸íŠ¹ë³„ì‹œ", "ê°•ë™êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬ ì•„ë¦¬ìˆ˜ë¡œ93ê¸¸ 47", 37.553258, 127.170669],
]
df = pd.DataFrame(data, columns=columns)

st.title("ğŸ“ ë‚´ ìœ„ì¹˜ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ì²­ì†Œë…„ ìƒë‹´ì„¼í„°")

# ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
coords = st_javascript(
    """
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const coords = {latitude: pos.coords.latitude, longitude: pos.coords.longitude};
            window.parent.postMessage(coords, "*");
        },
        (err) => {
            window.parent.postMessage({error: err.message}, "*");
        }
    );
    """,
    key="get_user_location"
)

# ê¸°ë³¸ ì¢Œí‘œ (ì„œìš¸ì‹œì²­)
default_lat, default_lon = 37.5665, 126.9780

# ì¢Œí‘œ ìœ íš¨ì„± í™•ì¸
if coords and "latitude" in coords and "longitude" in coords:
    user_lat = coords["latitude"]
    user_lon = coords["longitude"]
    st.success(f"ğŸ“Œ í˜„ì¬ ìœ„ì¹˜: {user_lat:.4f}, {user_lon:.4f}")
else:
    user_lat, user_lon = default_lat, default_lon
    st.warning("í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸ì‹œì²­)ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.")

# ê±°ë¦¬ ê³„ì‚° ë° ê°€ì¥ ê°€ê¹Œìš´ ì„¼í„° ì°¾ê¸°
df["ê±°ë¦¬"] = df.apply(lambda row: geodesic((user_lat, user_lon), (row["ìœ„ë„"], row["ê²½ë„"])).km, axis=1)
nearest = df.sort_values("ê±°ë¦¬").iloc[0]

st.subheader("ğŸ” ê°€ì¥ ê°€ê¹Œìš´ ìƒë‹´ì„¼í„°")
st.markdown(f"""
**ğŸ¢ ì„¼í„°ëª…:** {nearest['ì„¼í„°ëª…']}  
ğŸ“ **ì£¼ì†Œ:** {nearest['ì£¼ì†Œ']}  
ğŸ›£ï¸ **ê±°ë¦¬:** {nearest['ê±°ë¦¬']:.2f} km
""")

# ì§€ë„ ê·¸ë¦¬ê¸°
m = folium.Map(location=[user_lat, user_lon], zoom_start=12)
folium.Marker([user_lat, user_lon], tooltip="ë‚´ ìœ„ì¹˜", icon=folium.Icon(color="blue")).add_to(m)

# ì „ì²´ ì„¼í„° ë§ˆì»¤
for _, row in df.iterrows():
    folium.Marker([row["ìœ„ë„"], row["ê²½ë„"]], tooltip=row["ì„¼í„°ëª…"], icon=folium.Icon(color="green")).add_to(m)

# ê°€ì¥ ê°€ê¹Œìš´ ì„¼í„° ê°•ì¡°
folium.Marker([nearest["ìœ„ë„"], nearest["ê²½ë„"]], tooltip=f"ê°€ì¥ ê°€ê¹Œìš´ ì„¼í„°: {nearest['ì„¼í„°ëª…']}", icon=folium.Icon(color="red")).add_to(m)

st_folium(m, width=800, height=500)
