import streamlit as st
import pandas as pd
import folium
from streamlit_folium import st_folium
from geopy.distance import geodesic
from streamlit_javascript import st_javascript

# 센터 데이터 불러오기 (예: DataFrame로 직접 로딩)
columns = ["센터명", "시도명", "시군구명", "주소", "위도", "경도"]
data = [
    ["서울시청소년상담복지센터", "서울특별시", "중구", "서울특별시 중구 을지로 11길 23 7층", 37.566375, 126.990471],
    ["종로구청소년상담복지센터", "서울특별시", "종로구", "서울특별시 종로구 명륜길 90", 37.585501, 126.997992],
    ["용산구청소년상담복지센터", "서울특별시", "용산구", "서울특별시 용산구 백범로 329", 37.534241, 126.963403],
    ["성동구청소년상담복지센터", "서울특별시", "성동구", "서울특별시 성동구 행당로6길 24-15", 37.561491, 127.026402],
    ["광진구청소년상담복지센터", "서울특별시", "광진구", "서울특별시 광진구 아차산로 24길 17", 37.534201, 127.067332],
    ["동대문구청소년상담복지센터", "서울특별시", "동대문구", "서울특별시 동대문구 천호대로2길 23-9", 37.575294, 127.023249],
    ["중랑구청소년상담복지센터", "서울특별시", "중랑구", "서울특별시 중랑구 용마산로 217", 37.579624, 127.094595],
    ["성북구청소년상담복지센터", "서울특별시", "성북구", "서울특별시 성북구 정릉로 242", 37.600609, 127.009388],
    ["성북구석관청소년상담복지센터", "서울특별시", "성북구", "서울특별시 성북구 돌곶이로 18길 3-9", 37.610196, 127.064567],
    ["강북구청소년상담복지센터", "서울특별시", "강북구", "서울특별시 강북구 4.19로 74", 37.644161, 127.013580],
    ["도봉구청소년상담복지센터", "서울특별시", "도봉구", "서울특별시 도봉구 노해로 69길 132", 37.649313, 127.050419],
    ["노원구청소년상담복지센터", "서울특별시", "노원구", "서울특별시 노원구 수락산로212-19", 37.669865, 127.062013],
    ["은평구청소년상담복지센터", "서울특별시", "은평구", "서울특별시 은평구 백련산로 4길 16", 37.595995, 126.924844],
    ["서대문구청소년상담복지센터", "서울특별시", "서대문구", "서울특별시 서대문구 증가로30길 45-9", 37.575033, 126.923838],
    ["마포구청소년상담복지센터", "서울특별시", "마포구", "서울특별시 마포구 희우정로 77", 37.550186, 126.914264],
    ["양천구청소년상담복지센터", "서울특별시", "양천구", "서울특별시 양천구 남부순환로83길 53", 37.525624, 126.839847],
    ["강서구청소년상담복지센터", "서울특별시", "강서구", "서울특별시 강서구 화곡로 18길 14-5", 37.539655, 126.852447],
    ["구로구청소년상담복지센터", "서울특별시", "구로구", "서울특별시 구로구 오리로 1115", 37.487042, 126.814343],
    ["금천구청소년상담복지센터", "서울특별시", "금천구", "서울특별시 금천구 독산로32다길 17", 37.457813, 126.901616],
    ["영등포구청소년상담복지센터", "서울특별시", "영등포구", "서울특별시 영등포구 도영로22길 36", 37.524957, 126.902279],
    ["동작구청소년상담복지센터", "서울특별시", "동작구", "서울특별시 동작구 여의대방로 20길 61", 37.492067, 126.927237],
    ["관악구청소년상담복지센터", "서울특별시", "관악구", "서울특별시 관악구 남부순환로 234길 73", 37.484294, 126.931754],
    ["서초구청소년상담복지센터", "서울특별시", "서초구", "서울특별시 서초구 방배로5길 11", 37.486241, 126.989012],
    ["강남구청소년상담복지센터", "서울특별시", "강남구", "서울특별시 강남구 광평로 144", 37.487532, 127.1017],
    ["송파구청소년상담복지센터", "서울특별시", "송파구", "서울특별시 송파구 중대로 4길 4", 37.502934, 127.108922],
    ["강동구청소년상담복지센터", "서울특별시", "강동구", "서울특별시 강동구 아리수로93길 47", 37.553258, 127.170669],
]
df = pd.DataFrame(data, columns=columns)

st.title("📍 내 위치에서 가장 가까운 청소년 상담센터")

# 사용자 위치 가져오기
coords = st_javascript(
    """
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const coords = {latitude: pos.coords.latitude, longitude: pos.coords.longitude};
            window.parent.postMessage(coords, "*");
        },
        (err) => {
            window.parent.postMessage({error: err.message}, "*");
        }
    );
    """,
    key="get_user_location"
)

# 기본 좌표 (서울시청)
default_lat, default_lon = 37.5665, 126.9780

# 좌표 유효성 확인
if coords and "latitude" in coords and "longitude" in coords:
    user_lat = coords["latitude"]
    user_lon = coords["longitude"]
    st.success(f"📌 현재 위치: {user_lat:.4f}, {user_lon:.4f}")
else:
    user_lat, user_lon = default_lat, default_lon
    st.warning("현재 위치를 가져올 수 없습니다. 기본 위치(서울시청)로 설정합니다.")

# 거리 계산 및 가장 가까운 센터 찾기
df["거리"] = df.apply(lambda row: geodesic((user_lat, user_lon), (row["위도"], row["경도"])).km, axis=1)
nearest = df.sort_values("거리").iloc[0]

st.subheader("🔍 가장 가까운 상담센터")
st.markdown(f"""
**🏢 센터명:** {nearest['센터명']}  
📍 **주소:** {nearest['주소']}  
🛣️ **거리:** {nearest['거리']:.2f} km
""")

# 지도 그리기
m = folium.Map(location=[user_lat, user_lon], zoom_start=12)
folium.Marker([user_lat, user_lon], tooltip="내 위치", icon=folium.Icon(color="blue")).add_to(m)

# 전체 센터 마커
for _, row in df.iterrows():
    folium.Marker([row["위도"], row["경도"]], tooltip=row["센터명"], icon=folium.Icon(color="green")).add_to(m)

# 가장 가까운 센터 강조
folium.Marker([nearest["위도"], nearest["경도"]], tooltip=f"가장 가까운 센터: {nearest['센터명']}", icon=folium.Icon(color="red")).add_to(m)

st_folium(m, width=800, height=500)
